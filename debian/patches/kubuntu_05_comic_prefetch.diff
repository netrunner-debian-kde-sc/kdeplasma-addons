From: Matthias Fuchs <mat69@gmx.net>
Date: Thu, 07 Apr 2011 13:32:26 +0000
Subject: Fixes prefetching. Now constant useage of the comic applet does not lead to high memory usage.
X-Git-Url: http://quickgit.kde.org/?p=kdeplasma-addons.git&amp;a=commitdiff&amp;h=4ab9e40e1e3484a4adf059164c91e06d1f5b6b76
---
Fixes prefetching. Now constant useage of the comic applet does not lead to high memory usage.
REVIEW:101046
---


Index: kdeplasma-addons-4.6.2/applets/comic/comic.cpp
===================================================================
--- kdeplasma-addons-4.6.2.orig/applets/comic/comic.cpp	2011-04-10 10:40:19.520167015 +0200
+++ kdeplasma-addons-4.6.2/applets/comic/comic.cpp	2011-04-10 10:40:24.340167016 +0200
@@ -325,16 +325,26 @@
     }
 }
 
-void ComicApplet::dataUpdated( const QString&, const Plasma::DataEngine::Data &data )
+void ComicApplet::dataUpdated( const QString &source, const Plasma::DataEngine::Data &data )
 {
+    //disconnect prefetched comic strips
+    if ( source != mOldSource ) {
+        mEngine->disconnectSource( source, this );
+        return;
+    }
+
     setBusy( false );
     setConfigurationRequired( false );
     slotStartTimer();
 
     //there was an error, display information as image
-    if ( data[ "Error" ].toBool() ) {
-        if ( !mShowErrorPicture && !data[ "Previous identifier suffix" ].toString().isEmpty() ) {
-            updateComic( data[ "Previous identifier suffix" ].toString() );
+    const bool hasError = data[ "Error" ].toBool();
+    const bool errorAutoFixable = data[ "Error automatically fixable" ].toBool();
+    if ( hasError ) {
+        const QString previousIdentifierSuffix = data[ "Previous identifier suffix" ].toString();
+        if ( !mShowErrorPicture && !previousIdentifierSuffix.isEmpty() ) {
+            mEngine->disconnectSource( source, this );
+            updateComic( previousIdentifierSuffix );
             return;
         }
         QPixmap errorPic( 500, 400 );
@@ -420,6 +430,11 @@
     mLabelUrl->setText( mWebsiteUrl.host() );
     mImageWidget->setScaled( !mScaleComic );
 
+    //disconnect if there is either no error, or an error that can not be fixed automatically 
+    if ( !errorAutoFixable ) {
+        mEngine->disconnectSource( source, this );
+    }
+
     setTabBarVisible( mShowTabBar && mUseTabs );
     mLabelTop->setVisible( ( mShowComicAuthor || mShowComicTitle ) && !mLabelTop->text().isEmpty() );
     mLabelId->setVisible( mShowComicIdentifier && !mLabelId->text().isEmpty() );
@@ -449,11 +464,14 @@
 
     //prefetch the previous and following comic for faster navigation
     if ( !mNextIdentifierSuffix.isEmpty() ) {
-        mEngine->query( mComicIdentifier + ':' + mNextIdentifierSuffix );
+        const QString prefetch = mComicIdentifier + ':' + mNextIdentifierSuffix;
+        mEngine->connectSource( prefetch, this );
+        mEngine->query( prefetch );
     }
-
     if ( !mPreviousIdentifierSuffix.isEmpty() ) {
-        mEngine->query( mComicIdentifier + ':' + mPreviousIdentifierSuffix );
+        const QString prefetch = mComicIdentifier + ':' + mPreviousIdentifierSuffix;
+        mEngine->connectSource( prefetch, this );
+        mEngine->query( prefetch );
     }
 }
 
@@ -833,6 +851,7 @@
 
     setConfigurationRequired( mComicIdentifier.isEmpty() );
     if ( !mComicIdentifier.isEmpty() && mEngine && mEngine->isValid() ) {
+
         setBusy( true );
         const QString identifier = mComicIdentifier + ':' + identifierSuffix;
 
Index: kdeplasma-addons-4.6.2/dataengines/comic/comic.cpp
===================================================================
--- kdeplasma-addons-4.6.2.orig/dataengines/comic/comic.cpp	2011-04-10 10:40:19.530167015 +0200
+++ kdeplasma-addons-4.6.2/dataengines/comic/comic.cpp	2011-04-10 10:40:24.340167016 +0200
@@ -121,6 +121,7 @@
         if ( status != Solid::Networking::Connected && status != Solid::Networking::Unknown ) {
             mIdentifierError = identifier;
             setData( identifier, QLatin1String( "Error" ), true );
+            setData( identifier, QLatin1String( "Error automatically fixable" ), true );
             setData( identifier, QLatin1String( "Identifier" ), identifier );
             setData( identifier, QLatin1String( "Previous identifier suffix" ), lastCachedIdentifier( identifier ) );
             kWarning() << "No connection.";
