From 934743adaf468e377ff858be03c605a570391e3f Mon Sep 17 00:00:00 2001
From: Felix Geyer <debfx-kde@fobos.de>
Date: Sun, 1 Apr 2012 19:19:59 +0200
Subject: [PATCH] Support new FD.o desktop actions.
Forwarded: https://git.reviewboard.kde.org/r/104462/

---
 applets/icontasks/unityitem.cpp |   40 ++++++++++++++++++++++++--------------
 applets/icontasks/unityitem.h   |    3 ++
 2 files changed, 28 insertions(+), 15 deletions(-)

diff --git a/applets/icontasks/unityitem.cpp b/applets/icontasks/unityitem.cpp
index f653e4f..f952a45 100644
--- a/applets/icontasks/unityitem.cpp
+++ b/applets/icontasks/unityitem.cpp
@@ -28,7 +28,6 @@
 #include <QtGui/QAction>
 #include <QtGui/QMenu>
 #include <KDE/KDesktopFile>
-#include <KDE/KConfigGroup>
 #include <KDE/KRun>
 #include <KDE/KIcon>
 #include <dbusmenuimporter.h>
@@ -215,24 +214,35 @@ void UnityItem::readStaticMenu()
 
             KDesktopFile df(m_desktopFile);
             KConfigGroup de(&df, "Desktop Entry");
-            QStringList  shortCuts = de.readEntry("X-Ayatana-Desktop-Shortcuts", QString()).split(';');
-
-            foreach (QString shortcut, shortCuts) {
-                KConfigGroup grp(&df, shortcut + " Shortcut Group");
-                QString name = grp.readEntry("Name", QString());
-                QString exec = grp.readEntry("Exec", QString());
-
-                if (!name.isEmpty() && !exec.isEmpty()) {
-                    QString icon = grp.readEntry("Icon", QString()); // ???
-                    QAction *action = icon.isEmpty() ? new QAction(name, this) : new QAction(KIcon(icon), name, this);
-                    action->setData(exec);
-                    m_staticMenu.append(action);
-                    connect(action, SIGNAL(triggered()), this, SLOT(menuActivated()));
-                }
+
+            QStringList shortCutsFdo = de.readEntry("Actions", QString()).split(';');
+
+            foreach (QString shortcut, shortCutsFdo) {
+                parseDesktopAction(KConfigGroup(&df, "Desktop Action " + shortcut));
+            }
+
+            QStringList shortCutsAyatana = de.readEntry("X-Ayatana-Desktop-Shortcuts", QString()).split(';');
+
+            foreach (QString shortcut, shortCutsAyatana) {
+                parseDesktopAction(KConfigGroup(&df, shortcut + " Shortcut Group"));
             }
         }
         m_staticDirty = false;
     }
 }
 
+void UnityItem::parseDesktopAction(const KConfigGroup& grp)
+{
+    QString name = grp.readEntry("Name", QString());
+    QString exec = grp.readEntry("Exec", QString());
+
+    if (!name.isEmpty() && !exec.isEmpty()) {
+        QString icon = grp.readEntry("Icon", QString()); // ???
+        QAction *action = icon.isEmpty() ? new QAction(name, this) : new QAction(KIcon(icon), name, this);
+        action->setData(exec);
+        m_staticMenu.append(action);
+        connect(action, SIGNAL(triggered()), this, SLOT(menuActivated()));
+    }
+}
+
 #include "unityitem.moc"
diff --git a/applets/icontasks/unityitem.h b/applets/icontasks/unityitem.h
index 7e00501..3a76b43 100644
--- a/applets/icontasks/unityitem.h
+++ b/applets/icontasks/unityitem.h
@@ -31,6 +31,8 @@
 #include <QtCore/QVariant>
 #include <QtCore/QString>
 
+#include <KDE/KConfigGroup>
+
 class AbstractTaskItem;
 class QTimer;
 class QAction;
@@ -72,6 +74,7 @@ public Q_SLOTS:
 
 private:
     void readStaticMenu();
+    void parseDesktopAction(const KConfigGroup& grp);
 
 private:
     QString m_id;
-- 
1.7.9.1

